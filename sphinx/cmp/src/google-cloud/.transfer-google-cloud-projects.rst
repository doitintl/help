.. _google-cloud_transfer-google-cloud-projects:

Transfer Google Cloud Projects
==============================

.. epigraph::

   How to transfer your existing Google Cloud projects to your new billing account with DoiT International

Overview
--------

To change the Cloud Billing account for a project, you need to be able to move a project from your existing Cloud Billing account to another Cloud Billing account provided by DoiT International. To accomplish this task, you need permissions adequate to unlink the project from the existing Cloud Billing account AND to link the project to the target Cloud Billing account. Unfortunately, it is a manual process and requires a repetitive, one-by-one, transfer operation for each project. `Learn more. <https://cloud.google.com/billing/docs/how-to/modify-project#to_change_the_projects_account_do_the_following>`__

To make this process *much faster*, DoiT International developed a Project Transfer Tool in the Cloud Management Platform to help you bulk-transfer all of your existing Google Cloud projects to the billing account assigned to you by DoiT International.

.. DANGER::

   Changing the billing account linked to a project could disable and result in data loss for any partner-managed services purchased through Google Cloud Marketplace. `Learn more <https://cloud.google.com/marketplace/docs/understanding-billing#changing_a_projects_billing_account>`__

Let's see how this is done.

Get Service Account from CMP
----------------------------

Start with you logging into the `Cloud Management Platform <https://app.doit-intl.com>`__, and select '**Manage Licenses & Assets**' from the main dashboard:

.. image:: ../_assets/transfer-projects.png
   :alt: A screenshot showing the location of the _Manage Licenses & Assets_ section

Once you're at the **Assets** page, please switch to the Google Cloud tab.

.. image:: ../_assets/google-cloud-tab.png
   :alt: A screenshot showing the location of the _Google Cloud_ tab

To transfer your projects, locate your new Google Cloud billing account with DoiT International (doit.budgetao.com in this example), and click on the three-dots menu on the right-hand side of the widget. Choose 'Transfer Projects' to start the wizard.

.. image:: ../_assets/transfer-projects1\ (1)\ (1).png
   :alt: A screenshot showing the location of the _Transfer Projects_ option

Acknowledge the Marketplace Apps consent and click "Start":

.. image:: ../_assets/transfer-gcp.png
   :alt: A screenshot showing the start of the _Transfer Projects_ workflow

After you begin the transfer process, a dedicated Google Cloud service account will be generated to facilitate the transfer process.

Finally, **copy the service account name**. You will need it for the next step.

.. image:: ../_assets/transfer-projects3.png
   :alt: A screenshot showing you how to copy the service account name

Grant permissions to the service account
----------------------------------------

To ensure transfer wizard sees all of your projects let's grant "Billing Administrator" role for service account **both** on your current billing account and your GCP Organization.

You can either run gcloud CLI commands as listed in the wizard:

.. image:: ../_assets/image\ (58).png
   :alt: A screenshot showing you how to expand the CLI commands information

Or follow the detailed instructions below grant the access using GCP Console UI.

Grant permissions for GCP Organization
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

* Go to GCP `Resource Manager <https://console.cloud.google.com/cloud-resource-manager>`__
* Select your organization
* On the permissions info panel on the right, add the service account email as Billing Administrator Administrator

.. image:: ../_assets/image\ (55).png
   :alt: A screenshot showing you how to access the _Add Member_ button

.. image:: ../_assets/image\ (57).png
   :alt: A screenshot showing you the _Add members_ form

Grant permissions for Billing Account
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Per the instructions from the image above, we'll need to add the service account to your Google Cloud Organization IAM Policy with the "Billing Administrator" role.

First, navigate to your Google Cloud Console and click on "**Billing**"

.. image:: ../_assets/screen-shot-2021-02-12-at-11.28.16-am.png
   :alt: A screenshot showing you the location of the _Billing_ menu item

Next, click on "**Manage Billing Accounts**"

.. image:: ../_assets/screen-shot-2021-02-12-at-11.28.26-am.png
   :alt: A screenshot showing you the location of the _Manage Billing Accounts_ button

Make sure your organization is selected. Then select the billing account you want to edit.

.. image:: ../_assets/step3.jpg
   :alt: A screenshot showing you the billing account selection options

In the Billing Overview screen, select "Manage" on the right.

.. image:: ../_assets/screen-shot-2021-02-12-at-11.29.23-am.png
   :alt: A screenshot showing you the location of the _Manage_ option

Then, click the "**Show Info**" panel at the top-right to manage billing account members. From there, click "**Add Member**".

.. image:: ../_assets/add-member-project-transfer.jpg
   :alt: A screenshot showing you how to access the _Add Member_ button

Finally, paste the service account you copied earlier from the CMP Project Transfer tool and add the "Billing Account Administrator" role as shown below. Then click "Save".

.. image:: ../_assets/image\ (56).png
   :alt: A screenshot showing you the _Add members_ form

If you do not add the service account to your Google Cloud Organization IAM, the following error will appear.

.. WARNING::

   If you incorrectly add the service account to one of your Google Project IAM and not the Organization IAM, the following error will appear: **Service Account Not Found in Organization IAM**.

.. NOTE::

   If you don't have access to your Google Cloud Organization IAM, the Transfer Tool will provide you with a command you can send to your colleague who has the Organization IAM permission.

Transfer your Projects
----------------------

Select the projects you want to transfer to your new Google Cloud Billing Account with DoiT International.

.. image:: ../_assets/transfer-projects6.png
   :alt: A screenshot showing you the form allowing you to select which projects to transfer

By clicking the **&gt;** button, the selected projects are designated to be transferred. Review the list of projects you intend to transfer, validate it and click 'Finish'.

.. image:: ../_assets/transfer-projects7.png
   :alt: A screenshot showing you what it looks like after you have selected some projects to transfer

The confirmation page informs you of how many projects were transferred, and by selecting the 'Click here' button you can retrieve the full list of transferred projects as they will be copied to your clipboard.

.. image:: ../_assets/transfer-projects8.png
   :alt: A screenshot of the final success screen

Congrats! You have successfully reassigned your existing Google Cloud projects to your new billing account with DoiT International! Well done!

Partial Transfers
-----------------

If some or all of your projects don't transfer successfully, you will see a discrepancy when you complete your transfer process between the number of projects successfully transferred and the total number of projects you attempted to transfer.

If *some* of your projects transferred, this is the message you will see.

.. image:: ../_assets/screen-shot-2020-09-10-at-16.14.00-1-\ (1).png
   :alt: A screenshot showing you the final screen when only some projects were transferred

If none of your projects were successfully transferred, you will see this message.

.. image:: ../_assets/screen-shot-2020-09-10-at-16.10.34-1-.png
   :alt: A screenshot showing you the final screen when no projects were transferred

**Troubleshooting**
-----------------------

All / Some Projects Don't Transfer Successfully
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

There are a few "edge case" situations in which some or all of your Google Cloud projects won't transfer successfully:

#. The project(s) is associated with another Google Organization that the service account doesn"t have an access to.
#. The origin billing account is not under the Organization the service account has permissions to.

To identify which project(s) didn't transfer successfully, click on the hyperlinked "Click here" in the pop-up shown above. This will copy to clipboard all of the projects you attempted to transfer, as well as their statuses.

Here is an example output:

.. code-block:: text

   project-id-1, success
   project-id-2, success
   project-id-3, error-code

From here you can troubleshoot the project(s) that have "error-code" for one of the two "edge case" situations we described above.

Accidentally Added Service Account at the Project Level
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

As mentioned above, you will get an error if you add your service account to at the Project level and not the Organization level. The error will look something like: **"Service Account Not Found in Organization IAM"**.

To fix the situation please grant the service account Billing Account Admin role at the Organization level as described above and try again.

Video
-----

The following video shows you how to Transfer Google Cloud Projects.

.. raw:: html

   <div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 57.6307%;"><iframe src="https://www.loom.com/embed/c93a3375cbf447a7ae7027ffb9095973" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute; border: 0;" allowfullscreen scrolling="no" allow="encrypted-media;"></iframe></div>
